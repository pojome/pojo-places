var Pojo_Places=Pojo_Places||{};!function(){"use strict";Pojo_Places.GoogleApi={getDistance:function(a,b,c){return google.maps.geometry.spherical.computeDistanceBetween(c,this.getLocation(a,b))/10},getLocation:function(a,b){return new google.maps.LatLng(a,b)}}}(jQuery);var Pojo_Places=Pojo_Places||{};!function(a,b){"use strict";Pojo_Places.App={cache:{$document:a(document),$window:a(window)},cacheElements:function(){this.cache.$body=a("body"),this.cache.$placesWrap=a("div.pojo-places"),this.cache.$places_ul=this.cache.$placesWrap.find("ul.places"),this.cache.$places=this.cache.$places_ul.find("li.place-item"),this.cache.$loading=this.cache.$placesWrap.find("div.loading"),this.cache.$search_wrap=this.cache.$placesWrap.find("div.search-wrap"),this.cache.$search_box=this.cache.$search_wrap.find("input.search-box")},buildElements:function(){},bindEvents:function(){var b=this;b.userLocation=b.google_api.getLocation(Pojo.places.lat,Pojo.places.lng),b._googleListener(),b.cache.$placesWrap.find("button.get-geolocation-position").on("click",b._getLocationGetPosition),a(".places-input-filter").on("change",function(){b.cache.$places.addClass("hide").removeClass("filtered"),b.cache.$search_wrap.find(".places-input-filter:checked").each(function(){a('li[data-tags*=";'+a(this).val()+';"], li[data-category*=";'+a(this).val()+';"]',b.cache.$places_ul).addClass("filtered")}),a("li.filtered",b.cache.$places_ul).removeClass("hide")})},_getLocationGetPosition:function(){var a=Pojo_Places.App;navigator.geolocation.getCurrentPosition(function(b){a.cache.$loading.show(),a.userLocation=a.google_api.getLocation(b.coords.latitude,b.coords.longitude),a.geocoder.geocode({latLng:a.userLocation},function(b,c){c===google.maps.GeocoderStatus.OK&&b[0]&&a.cache.$search_box.val(b[0].formatted_address),a.cache.$loading.hide()}),a.renderPanel()})},_googleListener:function(){var a=this;if(1<=a.cache.$search_box.length){var c=new google.maps.places.Autocomplete(a.cache.$search_box[0],{types:["geocode"]});google.maps.event.addListener(c,"place_changed",function(){var d=c.getPlace().geometry;b!==d&&(a.userLocation=d.location,a.renderPanel())}),Modernizr.geolocation&&a.cache.$placesWrap.find("button.get-geolocation-position").show()}},renderPanel:function(){var b=this;b.cache.$places.each(function(){var c=Math.round(b.google_api.getDistance(Number(a(this).data("latitude")),Number(a(this).data("longitude")),b.userLocation));a(this).data("distance",c).find(".dist-debug").html("dist: "+c)}),b.cache.$places.sort(function(b,c){var d=parseInt(a(b).data("distance")),e=parseInt(a(c).data("distance"));return e>d?-1:d>e?1:0}),b.cache.$places_ul.append(b.cache.$places)},init:function(){this.google_api=Pojo_Places.GoogleApi,this.geocoder=new google.maps.Geocoder,this.cacheElements(),this.buildElements(),this.bindEvents(),this.renderPanel()}},a(document).ready(function(){Pojo_Places.App.init()})}(jQuery);