var Pojo_Places=Pojo_Places||{};!function(){"use strict";Pojo_Places.GoogleApi={getDistance:function(a,b,c){return google.maps.geometry.spherical.computeDistanceBetween(c,this.getLocation(a,b))/10},getLocation:function(a,b){return new google.maps.LatLng(a,b)}}}(jQuery),function(a,b,c,d){"use strict";function e(b,c){this.element=b,this.settings=a.extend({},g,c),this._defaults=g,this._name=f,this.cache={},this.init()}var f="pojoPlaces",g={};a.extend(e.prototype,{cacheElements:function(){this.cache.$placesWrap=a(this.element),this.cache.$places_ul=this.cache.$placesWrap.find("ul.places-list"),this.cache.$places=this.cache.$places_ul.find("li.place-item"),this.cache.$loading=this.cache.$placesWrap.find("div.loading"),this.cache.$search_wrap=this.cache.$placesWrap.find("div.search-wrap"),this.cache.$search_box=this.cache.$search_wrap.find("input.search-box"),this.cache.hasFilterTags=1<=a(".places-filter-tags",this.cache.$search_wrap).length,this.cache.hasFilterCategory=1<=a(".places-filter-category",this.cache.$search_wrap).length},buildElements:function(){},bindEvents:function(){var b=this;b.userLocation=b.google_api.getLocation(Pojo.places.lat,Pojo.places.lng),b.cache.$placesWrap.find("button.get-geolocation-position").on("click",function(){navigator.geolocation.getCurrentPosition(function(a){b.loading.show(b),b.userLocation=b.google_api.getLocation(a.coords.latitude,a.coords.longitude),b.geocoder.geocode({latLng:b.userLocation},function(a,c){c===google.maps.GeocoderStatus.OK&&a[0]&&b.cache.$search_box.val(a[0].formatted_address),b.loading.hide(b)}),b.renderPanel(b)})}),a(".places-input-filter, .places-filter-select",b.cache.$search_wrap).on("change",function(){b.loading.show(b),b.cache.$places.addClass("hide").removeClass("category-filtered").removeClass("tag-filtered");var c=[];b.cache.$search_wrap.find(".places-input-filter:checked, .places-filter-select").each(function(){var b=a(this);b.hasClass("places-filter-select")&&""===b.val()?b.find("option").each(function(){""!==a(this).val()&&c.push(a(this).val())}):c.push(b.val())}),a.each(c,function(c,d){a('li[data-category*=";'+d+';"]',b.cache.$places_ul).addClass("category-filtered"),a('li[data-tags*=";'+d+';"]',b.cache.$places_ul).addClass("tag-filtered")});var d="li";b.cache.hasFilterCategory&&(d+=".category-filtered"),b.cache.hasFilterTags&&(d+=".tag-filtered"),a(d,b.cache.$places_ul).removeClass("hide"),b.loading.hide(b)}),b._googleListener()},loading:{show:function(a){a.cache.$loading.show()},hide:function(a){a.cache.$loading.hide()}},_googleListener:function(){var a=this;if(1<=a.cache.$search_box.length){var b=new google.maps.places.Autocomplete(a.cache.$search_box[0],{types:["geocode"]});google.maps.event.addListener(b,"place_changed",function(){var c=b.getPlace().geometry;d!==c&&(a.userLocation=c.location,a.renderPanel(a))}),Modernizr.geolocation&&a.cache.$placesWrap.find("button.get-geolocation-position").trigger("click").show()}},renderPanel:function(b){b.cache.$places.each(function(){var c=Math.round(b.google_api.getDistance(Number(a(this).data("latitude")),Number(a(this).data("longitude")),b.userLocation));a(this).data("distance",c)}),b.cache.$places.sort(function(b,c){var d=parseInt(a(b).data("distance")),e=parseInt(a(c).data("distance"));return e>d?-1:d>e?1:0}),b.cache.$places_ul.append(b.cache.$places)},init:function(){this.google_api=Pojo_Places.GoogleApi,this.geocoder=new google.maps.Geocoder,this.cacheElements(),this.buildElements(),this.bindEvents(),this.renderPanel(this)}}),a.fn[f]=function(b){return this.each(function(){a.data(this,"plugin_"+f)||a.data(this,"plugin_"+f,new e(this,b))}),this}}(jQuery,window,document),jQuery(document).ready(function(a){"use strict";a("div.pojo-places").pojoPlaces()});